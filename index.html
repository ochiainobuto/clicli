<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://code.createjs.com/easeljs-0.8.1.min.js"></script>
</head>

<body>
    <div id="wrap">
        <div id="mask" class="hidden"></div>
        <section id="modal" class="hidden">
            <p>Please note that a very obscene voice will be played.<br>卑猥な音声が流れるので注意してください。</p>
            <div id="close">
            閉じる
            </div>
            <div id="result" align="center">
                <img src="qr_code.png" alt="海の写真" title="空と海">
            </div>
        </section>

        <div id="top">
            <canvas id="canvas1" width="380" height="570"></canvas>
        </div>
        <div id="top">
            <canvas id="graph" width="380" height="100"></canvas>
            <div id="result" align="center">タッチセンサー</div>
        </div>
    </div>
</body>

</html>
<style>
    body {
        background-color: black;
        }

    canvas {
        vertical-align: bottom;
        font-size:0px;
    }

    #top {
        text-align: center;
        margin: 0;
        padding: 0;
        vertical-align: bottom;
    }

    #result {
        display: block;
        top: 100;
        left: 0;
        width: 100%;
        height: auto;
        text-align: center;
        margin: 0;
        padding: 0;
    }

    #qr {
        display: block;
        position: absolute;
        top: 100;
        left: 0;
        width: 100%;
        height: auto;
        text-align: center;
        margin: 0;
        padding: 0;
    }

    #close {
        cursor: pointer;
        width: 200px;
        border: 1px solid #ccc;
        border-radius: 4px;
        text-align: center;
        padding: 12px;
        margin: 16px auto 0;
        background: #4caf50;
        color: white;
        position: relative;
        top: 30%;
    }

    #mask {
        background: rgba(0, 0, 0, 0.4);
        position: fixed;
        top: 0;
        bottom: 0;
        right: 0;
        left: 0;
        z-index: 1;
    }

    #modal {
        background: #fff;
        color: #555;
        width: 300px;
        padding: 10px;
        border-radius: 4px;
        position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            -webkit-transform: translate(-50%, -50%);
            -ms-transform: translate(-50%, -50%);
        margin: 0 auto;
        z-index: 2;
    }

    #modal p {
        margin: 0 0 20px;
    }

    #mask.hidden {
        display: none;
    }

    #modal.hidden {
        display: none;
    }

</style>

<script>
    //Reset
    window.addEventListener('touchmove', function (event) {
        event.preventDefault();
    });

    /* -----------------------------------------------------------------
    スタートの警告
    -------------------------------------------------------------------- */

    window.addEventListener("load", function() {
        // 実行したい処理
        modal.classList.remove('hidden');
        mask.classList.remove('hidden');
    });

    const close = document.getElementById('close');
    const modal = document.getElementById('modal');
    const mask = document.getElementById('mask');


    close.addEventListener('click', function () {
        modal.classList.add('hidden');
        mask.classList.add('hidden');
        //voice();
    });
    mask.addEventListener('click', function () {
        modal.classList.add('hidden');
        mask.classList.add('hidden');
        //voice();
    });


    /* -----------------------------------------------------------------
    各種オブジェクトの作成
    -------------------------------------------------------------------- */
    var canvas = document.getElementById("canvas1");
    var _canvas = document.getElementById("graph");
    var ctx = canvas.getContext('2d');
    var _ctx = _canvas.getContext('2d');

    var count = 0;

    //var canvas = document.getElementById("canvas1"); // 実際に描画が行われる Canvas要素
    var stage = new createjs.Stage(canvas); // Stage クラスのインスタンスを作成する
    var text = new createjs.Text("Let's Click!" + count, "20px Arial", "#ff7700"); // Text クラスのインスタンスを作成する

    //クリトリスまる
    var circle = new createjs.Shape();
    circle.graphics.beginFill("rgb(222, 60, 92)").drawCircle(0, 0, 14);
    circle.x = canvas.width * 0.5;
    circle.y = canvas.height * 0.2;
    circle.scaleY = 1.6;
    //circle.alpha = 0.5;

    // 下の画像の先読み処理
    var baseimg = new Image();
    baseimg.src = "bg.jpg";
    // 画像の読み込み完了後に Bitmap のインスタンスを作成する
    baseimg.onload = function () {preX
        basemap = new createjs.Bitmap("bg2.jpg");
        //basemap.y = 100;
        basemap.scaleX = 1.0 // x方向の拡大率変更
        basemap.scaleY = 1.0 // y方向の拡大率変更
        stage.addChild(basemap);
    };

    // 上の画像の先読み処理
    var img = new Image();
    img.src = "fr1.png";

    /* -----------------------------------------------------------------
    createjsのモデルを配置　画像の読み込み完了後に Bitmap のインスタンスを作成する
    -------------------------------------------------------------------- */
    //var bitmap = new Image();
    img.onload = function () {
        bitmap = new createjs.Bitmap("fr2.png");
        //bitmap.y = 100;
        bitmap.scaleX = 1.0 // x方向の拡大率変更
        bitmap.scaleY = 1.0 // y方向の拡大率変更
        stage.addChild(circle, bitmap, text);
        stage.update();
        stretch();
    };
    /* -----------------------------------------------------------------    
    //徐々に元の大きさに小さくなる　＆　Voice のきりかえ
    -------------------------------------------------------------------- */
    var voice1_volume;

    function stretch() {
        createjs.Ticker.framerate = 40
        createjs.Ticker.addEventListener("tick", function () {
            if (bitmap.scaleX > 0.3) {
                bitmap.scaleX = bitmap.scaleX - (bitmap.scaleX - 0.3) * 0.01;
            }

            bitmap.regX = bitmap.image.width / 2;
            bitmap.regY = bitmap.image.height / 2;
            bitmap.x = canvas.width * 0.5;
            bitmap.y = canvas.height * 0.5;

            if (circle.scaleX > 1) {
                circle.scaleX = circle.scaleX - (circle.scaleX - 1) * 0.02;
            }
            stage.update();

            /* -----------------------------------------------------------------
            Voice のきりかえ
            -------------------------------------------------------------------- */
            // document.getElementById("result").innerHTML = bitmap.scaleX;
            // document.getElementById("result").style.color = "red";

            // voice1.volume = (Math.min(Math.max(0, bitmap.scaleX), 0.5) - 0.3)*0.5;
            // voice2.volume = (Math.min(Math.max(0.5, bitmap.scaleX), 0.8) - 0.5)*0.33;
            // voice3.volume = (Math.min(Math.max(0.8, bitmap.scaleX), 1.0) - 0.7)*0.5;
            
            return;
        })

    }


    /* -----------------------------------------------------------------
    MouseEvent
    -------------------------------------------------------------------- */
    var music = new Audio('./voice/neiki_01-01.wav');

    var dragging = false;
    circle.addEventListener("mousedown", handleDown);
    // circle.addEventListener("pressmove", handleMove);
    circle.addEventListener("pressup", handleUp);

    function handleDown(event) {
        circle.scaleX += 0.03;
        bitmap.scaleX += 0.08;

        count += 1;
        text.text = "Click!" + count;
        console.log(count);
        // if(window.navigator.vibrate){
        //     window.navigator.vibrate([200,200,200,200,200]);
        //   }else if(window.navigator.mozVibrate){
        //     window.navigator.mozVibrate([200,200,200]);
        //   }else if(window.navigator.webkitVibrate){
        //     window.navigator.webkitVibrate([200]);
        //   }else{
        //     alert("sorry (T-T)");
        //   } 

        console.log('Click');
        dragging = true;
        
        console.log(music.ended);
        music.play();  // 再生
        console.log(music.ended);

    }

    function handleUp(event) {
        console.log('Up');
        dragging = false
    }

    /* -----------------------------------------------------------------
    Stretch
    -------------------------------------------------------------------- */
    // 基本の距離
    var baseDistance = 0;
    var startTime = Date.now();
    var preX = 0, preY = 0;
    var arr = [];
    var _preX = 0, _preY = 0;
    var _arr = [];

    // 距離を測る関数
    function getDistance(event) {
        event.preventDefault();

        var touches = event.changedTouches;

        // 2本以上の指の場合だけ処理
        if (touches.length > 1) {
            // 座標1 (1本目の指)
            var x1 = touches[0].pageX;
            var y1 = touches[0].pageY;

            // 座標2 (2本目の指)
            var x2 = touches[1].pageX;
            var y2 = touches[1].pageY;

            // 2点間の距離
            return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
        }
        return 0;
    }

    //Drag中に大きくする
    function drag() {
        if (bitmap.scaleX < 1.1) {
            bitmap.scaleX = bitmap.scaleX + bitmap.scaleX * 0.0105;
        }
        bitmap.regX = bitmap.image.width / 2;
        bitmap.regY = bitmap.image.height / 2;
        bitmap.x = canvas.width * 0.5;
        bitmap.y = canvas.height * 0.5;

        if (circle.scaleX < 1.1) {
            circle.scaleX = circle.scaleX + circle.scaleX * 0.02;
        }
    }
    
    /* -----------------------------------------------------------------
    Audio 読み込み
    -------------------------------------------------------------------- */

    // var voice1 = new Audio(); // audioの作成
    // voice1.src = './voice/neiki_01.wav'; // 音声ファイルの指定
    // voice1.load(); // audioの読み込み

    // var voice2 = new Audio(); // audioの作成
    // voice2.src = './voice/kakokyu_01.wav'; // 音声ファイルの指定
    // voice2.load(); // audioの読み込み

    // var voice3 = new Audio(); // audioの作成
    // voice3.src = './voice/kakokyu_03.wav'; // 音声ファイルの指定
    // voice3.load(); // audioの読み込み

    // function voice(){
    //     voice1.play();  // 再生
    //     voice1.addEventListener("ended", function () {
    //         voice1.currentTime = 0;
    //         setTimeout(function(){
    //         voice1.play();
    //         },1000);
    //     })

    //     voice2.play();  // 再生
    //     voice2.addEventListener("ended", function () {
    //         voice2.currentTime = 0;
    //         setTimeout(function(){
    //         voice2.play();
    //         },1000);
    //     })

    //     voice2.play();  // 再生
    //     voice2.addEventListener("ended", function () {
    //         voice2.currentTime = 0;
    //         setTimeout(function(){
    //         voice2.play();
    //         },1000);
    //     })
    // }


    var audio = document.createElement('audio');
    document.body.appendChild(audio);
    var playlist = [
    './voice/neiki_01-01.mp3',
    './voice/neiki_01-02.mp3',
    './voice/neiki_01-03.mp3',
    './voice/neiki_01-04.mp3',
    './voice/neiki_01-05.mp3',
    './voice/neiki_01-06.mp3',
    './voice/neiki_01-07.mp3',
    './voice/neiki_01-08.mp3',
    './voice/neiki_01-09.mp3',
    './voice/neiki_01-10.mp3',
    './voice/neiki_01-11.mp3',
    './voice/neiki_01-12.mp3'
    ]
    var voice_list = [];
    for (var value of playlist) {
        var voice = new Audio();
        voice.src = value; // 音声ファイルの指定
        voice.load(); // audioの読み込み
        voice_list.push(voice);
    }

    /* -----------------------------------------------------------------
    Update 値を監視して、常にストレッチを更新する 
    -------------------------------------------------------------------- */

    window.onload = function () {
        var xDist = 0;
        var yDist = 0;
        var x0 = 0;
        var y0 = 0;
        var dragging;
        var previous_num;

        // Click ON
        //document.getElementById("canvas1").onmousedown = function (event) {
        document.getElementById("canvas1").ontouchstart = function (event) {
            console.log('Down');
            if (event.changedTouches) {
                x0 = event.changedTouches[0].pageX;
                y0 = event.changedTouches[0].pageY;
            }
            else {
                x0 = event.pageX;
                y0 = event.pageY;
            }
            dragging = true;
            
            previous_num = Math.floor( Math.random() * voice_list.length);
            voice_list[previous_num].play(); 
        }
        //Drag Over
        //document.getElementById("canvas1").onmousemove = function (event) {
        document.getElementById("canvas1").ontouchmove = function (event) {
            console.log('Drag');
            if (event.changedTouches) {
                xDist = event.changedTouches[0].pageX - x0;
                yDist = event.changedTouches[0].pageY - y0;
                x0 = event.changedTouches[0].pageX;
                y0 = event.changedTouches[0].pageY;
                arr.push( {"t": Date.now() - startTime, "x": x0, "y": y0}); 
                _arr.push( {"t": Date.now() - startTime, "x": xDist, "y": yDist}); 
                drag();
            }
            else {
                console.log(dragging);
                if(dragging == true)
                {
                    xDist = event.pageX - x0;
                    yDist = event.pageY - y0;
                    x0 = event.pageX;
                    y0 = event.pageY;
                    arr.push( {"t": Date.now() - startTime, "x": x0, "y": y0}); 
                    _arr.push( {"t": Date.now() - startTime, "x": xDist, "y": yDist}); 
                    
                    //Drag中に大きくする
                    drag();
                    stage.update();

                    ///// Sound Play
                
                    if(voice_list[previous_num].currentTime > 0.7){
                        previous_num = Math.floor( Math.random() * voice_list.length);
                        voice_list[previous_num].play(); 
                    }
                }
            }

            /// ストレッチ
            if (event.changedTouches) {
                if (baseDistance) {
                    // 変化後の距離
                    var movedDistance = getDistance(event);
                } else {
                    // 基本の距離
                    baseDistance = getDistance(event);
                }
                if (movedDistance / baseDistance > 0) {
                    bitmap.scaleX += 0.04;
                }
            }

            //テキストを入れ替えます。
            document.getElementById("result").style.color = "red";
            document.getElementById("result").innerHTML = xDist + yDist;
  
        }

        //Mouse UP
        //document.getElementById("canvas1").onmouseup = function (event) {
        document.getElementById("canvas1").touchend = function (event) {
            console.log('Up');
            xDist = 0;
            yDist = 0;
            dragging = false;

        }

        //フォームが持つデフォルトの動作をキャンセルするメソッドです。
        document.ontouchmove = function () { event.preventDefault(); }

    }



    /* -----------------------------------------------------------------
    displayData 加速度データをグラフ表示する
    -------------------------------------------------------------------- */
    function displayData() {

        if ( ! canvas || ! canvas.getContext ) { return false; }
        _ctx.fillStyle = "rgb(0, 0, 0)";
        _ctx.fillRect( 0, 0, canvas.clientWidth, canvas.clientHeight );
        _ctx.lineWidth = 1 ;

        // 最新から 300px 分のデータを取りだす。
        var varr = [];
        if ( arr.length > canvas.clientWidth){
            varr = arr.slice(-canvas.clientWidth,-1);
        }else{
            varr = arr;
        }
        
        //軌跡
        // for ( idx in varr ){
        //     if ( idx > canvas.clientWidth ) break;
        //     var dat = varr[idx];

        //     if(idx == 0){
        //         preX = dat.x;
        //         preY = dat.y;
        //     }

        //     // 跡を書く
        //     ctx.strokeStyle = "green";
        //     ctx.beginPath();
        //     ctx.moveTo(dat.x,dat.y);
        //     ctx.lineTo(preX,preY);
        //     ctx.stroke();

        //     preX = dat.x;
        //     preY = dat.y;
        // }

        // 加速度
        var _varr = [];
        if ( _arr.length > canvas.clientWidth){
            _varr = _arr.slice(-canvas.clientWidth,-1);
        }else{
            _varr = _arr;
        }

        for ( idx in _varr ){
            if ( idx > _canvas.clientWidth ) break;
            var dat = _varr[idx];

            // X 軸加速度を赤の線で表示する
            var dy1 = _canvas.clientHeight/2 + dat.x * 5.0;
            var dx = idx;
            _ctx.strokeStyle = "red";
            _ctx.beginPath();
            _ctx.moveTo(dx,dy1);
            _ctx.lineTo(dx-1,_preX);
            _ctx.stroke();

            // Y 軸加速度を青の線で表示する
            var dy2 = _canvas.clientHeight/2 + dat.y * 5.0;
            _ctx.strokeStyle = "blue";
            _ctx.beginPath();
            _ctx.moveTo(dx,dy2);
            _ctx.lineTo(dx-1,_preY);
            _ctx.stroke();
            
            // 次のデータを表示するときに前のデータから線を描く用
            _preX = dy1;
            _preY = dy2;
        }


    }

    // ブラウザのレンダリングのタイミングにあわせて表示を更新
    (function loop(){
        displayData();
        // update();
        window.requestAnimationFrame(loop);
    }());

    /* -----------------------------------------------------------------
    ピッチインピッチアウトによる拡大縮小を禁止
    -------------------------------------------------------------------- */
    document.documentElement.addEventListener('touchstart', function (e) {
        if (e.touches.length >= 2) { e.preventDefault(); }
    }, { passive: false });

</script>